import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import com.binarydevs.DAO.AdminRepository;
import com.binarydevs.DTOs.AdminUserLogin;
import com.binarydevs.Entities.AdminUser;
import com.binarydevs.configs.jwtConfig.CustomerUserDetailsService;
import com.binarydevs.configs.jwtConfig.JwtService;

@Service
public class BinaryDevsAdminService {

    private final AdminRepository adminRepo;
    private final PasswordEncoder encoder;
    private final AuthenticationProvider authProvider;
    private final JwtService jwtService;
    private final CustomerUserDetailsService userDetailsService;

    private final Logger log = LoggerFactory.getLogger(getClass());

    public BinaryDevsAdminService(
            AdminRepository adminRepo,
            PasswordEncoder encoder,
            AuthenticationProvider authProvider,
            JwtService jwtService,
            CustomerUserDetailsService userDetailsService
    ) {
        this.adminRepo = adminRepo;
        this.encoder = encoder;
        this.authProvider = authProvider;
        this.jwtService = jwtService;
        this.userDetailsService = userDetailsService;
    }

    /* ================= REGISTER ================= */

    public ResponseEntity<?> registerUser(AdminUser userDetails) {
        userDetails.setPassword(encoder.encode(userDetails.getPassword()));
        return ResponseEntity.ok(adminRepo.save(userDetails));
    }

    /* ================= LOGIN ================= */

    public ResponseEntity<?> login(AdminUserLogin userLogin) {

        Authentication authentication = authProvider.authenticate(
                new UsernamePasswordAuthenticationToken(
                        userLogin.getEmail(),
                        userLogin.getPassword()
                )
        );

        UserDetails userDetails =
                (UserDetails) authentication.getPrincipal();

        String accessToken =
                jwtService.generateJwtToken(userDetails.getUsername());

        String refreshToken =
                jwtService.generateRefreshToken(userDetails);

        AdminUser user =
                adminRepo.findByEmail(userDetails.getUsername())
                        .orElseThrow(() -> new RuntimeException("User not found"));

        user.setRefreshToken(refreshToken);
        adminRepo.save(user);

        return ResponseEntity.ok(
                Map.of(
                        "accessToken", accessToken,
                        "refreshToken", refreshToken,
                        "role", user.getRole()
                )
        );
    }

    /* ================= REFRESH ================= */

    public ResponseEntity<?> generateAccessToken(String refreshToken) {

        if (refreshToken.startsWith("Bearer ")) {
            refreshToken = refreshToken.substring(7);
        }

        try {
            String username = jwtService.extractUsername(refreshToken);

            UserDetails userDetails =
                    userDetailsService.loadUserByUsername(username);

            AdminUser user =
                    adminRepo.findByEmail(username)
                            .orElseThrow(() -> new RuntimeException("User not found"));

            // üîê CRITICAL SECURITY CHECK
            if (!refreshToken.equals(user.getRefreshToken())) {
                throw new RuntimeException("Refresh token mismatch");
            }

            if (!jwtService.isRefreshToken(refreshToken)
                    || !jwtService.isTokenValid(refreshToken, userDetails)) {
                throw new RuntimeException("Refresh token invalid or expired");
            }

            String newAccessToken =
                    jwtService.generateJwtToken(username);

            return ResponseEntity.ok(
                    Map.of("accessToken", newAccessToken)
            );

        } catch (Exception error) {
            log.error("Refresh token error", error);
            return ResponseEntity.status(401)
                    .body(Map.of("error", error.getMessage()));
        }
    }
}
